module load PrgEnv-gnu
module load rocm/4.2.0
module load cray-mpich
module load cray-hdf5-parallel
#module load craype-accel-amd-gfx908


## These must be set before compiling so the executable picks up GTL
export PE_MPICH_GTL_DIR_amd_gfx908="-L/opt/cray/pe/mpich/8.1.4/gtl/lib"
export PE_MPICH_GTL_LIBS_amd_gfx908="-lmpi_gtl_hsa"


# Need a new version of cmake
export CMAKE_DIR=/gpfs/alpine/csc380/proj-shared/LBPM/cmake-3.21.0/bin


# configure
rm -rf CMake*
${CMAKE_DIR}/cmake                              \
    -D CMAKE_BUILD_TYPE:STRING=Release          \
    -D CMAKE_CXX_COMPILER:PATH=CC               \
    -D CMAKE_CXX_STANDARD=14                    \
    -D DISABLE_GOLD:BOOL=TRUE                   \
    -D DISABLE_LTO:BOOL=TRUE                    \
    -D USE_HIP=1                                \
        -D CMAKE_HIP_COMPILER_TOOLKIT_ROOT=$ROCM_PATH/hip \
    -D USE_MPI=1                                \
    -D MPI_SKIP_SEARCH=1                        \
    -D MPIEXEC="srun"                           \
    -D USE_HDF5=1                               \
        -D HDF5_DIRECTORY="${HDF5_DIR}"         \
    -D USE_SILO=0                               \
    -D USE_TIMER=0			        \
    -D USE_DOXYGEN:BOOL=false		        \
    ~/LBPM-WIA


